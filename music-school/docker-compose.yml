version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: music-school-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password_change_me}
      MYSQL_DATABASE: music_school
      MYSQL_USER: ${MYSQL_USER:-music_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-music_password_change_me}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - music-school-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: music-school-backend
    restart: always
    environment:
      NODE_ENV: production
      PORT: 5000
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: music_school
      DB_USER: ${MYSQL_USER:-music_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-music_password_change_me}
      JWT_SECRET: ${JWT_SECRET:-your_jwt_secret_change_me}
      JWT_EXPIRES_IN: 7d
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - music-school-network
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.music-school-api.rule=Host(`${API_DOMAIN:-api.musicschool.com}`)"
      - "traefik.http.routers.music-school-api.entrypoints=websecure"
      - "traefik.http.routers.music-school-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.music-school-api.loadbalancer.server.port=5000"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-https://api.musicschool.com}
    container_name: music-school-frontend
    restart: always
    depends_on:
      - backend
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.music-school-app.rule=Host(`${APP_DOMAIN:-musicschool.com}`) || Host(`www.${APP_DOMAIN:-musicschool.com}`)"
      - "traefik.http.routers.music-school-app.entrypoints=websecure"
      - "traefik.http.routers.music-school-app.tls.certresolver=letsencrypt"
      - "traefik.http.services.music-school-app.loadbalancer.server.port=80"
      # Redirect www to non-www
      - "traefik.http.middlewares.music-school-redirect.redirectregex.regex=^https://www.(.+)"
      - "traefik.http.middlewares.music-school-redirect.redirectregex.replacement=https://$${1}"
      - "traefik.http.routers.music-school-app.middlewares=music-school-redirect"

volumes:
  mysql_data:

networks:
  music-school-network:
    driver: bridge
  traefik-public:
    external: true
